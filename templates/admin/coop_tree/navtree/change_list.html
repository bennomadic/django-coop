{% extends "admin/base_site.html" %}
{% load i18n static adminmedia %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% admin_media_prefix %}css/changelists.css" />
{% endblock %}

{% block extrahead %}
<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}css/tree.css" />
<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}css/smoothness/jquery-ui-1.8.14.custom.css" />
<script src="{{STATIC_URL}}js/jquery-1.5.1.min.js"></script>
<script src="{{STATIC_URL}}js/jquery-ui-1.8.14.custom.min.js"></script>
{% include "djaloha/_csrf_ajax_jquery.html" %}
<script src="{{STATIC_URL}}js/jquery.jstree.js"></script>
<script type="text/javascript">
  $(function() {
    var last_selection = null;

    var admin_hideMessage = function ()  {
        $('#admin-status').hide();
        $(".error-field").removeClass("error-field");
    };
    
    var admin_printMessage = function (message, css_class) {
        $('#admin-status').removeClass().html(message).addClass(css_class).show();
        setTimeout(admin_hideMessage, 3000);
    };

    function disable_actions() {
      $("#rename_node").attr('disabled', 'disabled');
      $("#delete_node").attr('disabled', 'disabled');    
    }
    
    function enable_actions() {
      $("#rename_node").removeAttr('disabled');
      $("#delete_node").removeAttr('disabled');
    }
    disable_actions();
    
    function post_msg(msg_id, data, callback) {
      data['msg_id'] = msg_id;
      $.post(
        "{{cl.model_admin.get_absolute_url}}",
        data,
        callback,
        'json'
      );
    }
    
    function get_node_id(node) {
      return node.attr("id").slice(5);
    }
    
    $("#add_object").click(function() {
      data = {msg_id: 'add_navnode'};
      data["object_type"] = $("#object_types option:selected").attr("id");
      data["object_id"] = $("#object_id").val();
      try {
        var selected_nodes = $("#nodes").jstree('get_selected');
        data['parent_id'] = get_node_id($(selected_nodes[0]));
      } catch (ex) {
        //alert(''+ex);
      }
      post_msg('add_navnode', data,
        function(data) {
          admin_printMessage(data.message, data.status);
          if (data.status==='success') {
            $("#nodes").jstree("create",null,"last",{data:data.label, attr:{id: data.id}});
          }
        }
      );
    });
    
    $("#object_types").change(function() {
      $("#object_label").val("");
      $("#object_id").val("");
    });
    
    $("#nodes").jstree({ 
      "dnd" : {
        "drop_target": false,
        "drag_target": false,
        "drag_check" : function () { 
          return { after : true, before : true, inside : true };
        }
      },
      "ui" : {
        "select_limit" : 1,
      },
      "plugins" : [ "themes", "html_data", "dnd", "ui", "crrm" ]
    })
    
    $("#nodes").bind("move_node.jstree", function (event, data) {
      var tree_data = {
        node_id: get_node_id(data.rslt.o),
        ref_pos: data.rslt.p,
      };
      try {
        tree_data['ref_id'] = get_node_id(data.rslt.or);
      } catch (ex) {}
        
      try {
        tree_data['parent_id'] = get_node_id(data.rslt.np);
      } catch (ex) {}
      
      post_msg('move_navnode', tree_data, function(data) {
        admin_printMessage(data.message, data.status);
      });
    })
    $("#nodes").bind("rename_node.jstree", function (event, data) {
        var tree_data = {
        node_id: get_node_id(data.rslt.obj),
        name: data.rslt.name,
        };
        post_msg('rename_navnode', tree_data, function(data) {
          admin_printMessage(data.message, data.status);
          deselect_all();
        });
    });
    
    function deselect_all() {
      $("#nodes").jstree("deselect_all");
      disable_actions();
      last_selection = null;
      $("#aside").html("");
    }
    
    $("#nodes").bind("select_node.jstree", function (event, data) {
      if (last_selection === get_node_id(data.rslt.obj)) {
          deselect_all();
      } else {
        last_selection = get_node_id(data.rslt.obj);
        enable_actions();
        
        post_msg('view_navnode', {node_id: get_node_id(data.rslt.obj)}, 
          function(data) {
            //admin_printMessage(data.message, data.status);
            if (data.status === "success") {
              $("#aside").html(data.html);
            } else {
              $("#aside").html("");
            }
          }
        );
      }
    });
    
    $("#object_label").autocomplete({
        source: function(req, add){
          var object_type = $("#object_types option:selected").attr("id");
          $.getJSON("{% url object_suggest_list %}?object_type="+object_type, req, function(data) {
            var existing_objects = [];
            $.each(data, function(i, val){
              existing_objects.push(val);
            });
            add(existing_objects);
          });
        },
        select: function(event, ui) {
          $("#object_label").val(ui.item.label);
          $("#object_id").val(ui.item.value);
          return false;
        },
        focus: function(event, ui) {
          $("#object_label").val(ui.item.label);
          $("#object_id").val(ui.item.value);
          return false;
        }
    });
    
    $("#rename_node").click(function () { 
		$("#nodes").jstree("rename"); 
	});
    $("#delete_node").click(function () {
      var selected_nodes = $("#nodes").jstree('get_selected');
      var length = selected_nodes.length;
      if (length>0){
        var confirm_msg = '{% trans "Are you sure to delete the selected node?"%}'
        if (confirm(confirm_msg)) {
          var node_ids = [];
          for (var i=0; i<length; i++) {
            node_ids.push(get_node_id($(selected_nodes[i])))
          }
          post_msg('remove_navnode', {'node_ids': node_ids.join(";")}, function(data) {
            admin_printMessage(data.message, data.status);
            if (data.status === "success"){
              for (var i=0; i<length; i++) {
                $("#nodes").jstree("remove", "#"+$(selected_nodes[i]).attr("id"));
              }
            }
          });
        }
      }
	});
  })();
</script>
{% endblock %}

{% block bodyclass %}change-list{% endblock %}

{% if not is_popup %}
  {% block breadcrumbs %}
    <div class="breadcrumbs">
      <a href="../../">
        {% trans "Home" %}
      </a>
       &rsaquo;
       <a href="../">
         {{ app_label|capfirst }}
      </a>
      &rsaquo;
      {{ cl.opts.verbose_name_plural|capfirst }}
    </div>
  {% endblock %}
{% endif %}

{% block coltype %}flex{% endblock %}

{% block content_title %}<h1>{% trans "Navigation tree" %}</h1>{% endblock %}

{% block content %}
<noscript><div id="jswarning">{% trans "The site requires javascript to be enabled!" %}</div></noscript>
<div id="content">
    <div class="button-bar">
        <span class="add_object_section">
            <button id="add_object">{% trans "Add a new node" %}</button>
            <select id="object_types">
            {% for nt in cl.model_admin.nav_types %}
                <option id="{{nt.type}}">{{nt.label}}</option>
            {% endfor %}
            </select>
            <input id="object_label" size=30/>
            <input id="object_id" type="hidden"/>
        </span>
        <button id="rename_node">{% trans "Rename" %}</button>
        <button id="delete_node">{% trans "Remove" %}</button>
        <span id="admin-status"></span>
    </div>
    <div id="aside">
    </div>

    <div id="nodes" class="">
        <ul>{{cl.model_admin.nodes_li|safe}}</ul>
    </div>
</div>
{% endblock %}
